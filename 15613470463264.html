
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  LiveDataç»„ä»¶åˆ†äº« - é‡ç«ğŸ”¥
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="ç”Ÿå‘½å¦‚é‡ç«ï¼Œéª„å‚²è€Œé¡½å¼º">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="é‡ç«ğŸ”¥" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//é“¾æ¥æ–°å¼€çª—å£
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">é‡ç«ğŸ”¥</a></h1>
  
    <h2>ç”Ÿå‘½å¦‚é‡ç«ï¼Œéª„å‚²è€Œé¡½å¼º</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.chaisong.xyz" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">Home</a></li>

  <li id=""><a target="_self" href="archives.html">Archives</a></li>

  <li id=""><a target="_self" href="aboutme.html">ABOUT ME</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div>
	<article class="hentry" role="article">
	<header>
			  	<h1 class="entry-title">LiveDataç»„ä»¶åˆ†äº«</h1>
				<p class="meta"><time datetime="2019-03-24T11:30:46+08:00" pubdate data-updated="true">2019/3/24</time></p>
			 </header>
		  	<div class="entry-content">
			  	<p><strong>å…«å¦æš–åœºç¯èŠ‚</strong></p>

<h1 id="toc_0">å¼•ï¼šä»Google AAC å’Œ MVVMå¼€å§‹è¯´èµ·</h1>

<blockquote>
<p>LiveDataæ¨å‡ºäºGoogle I/O 2017 çš„ architecture components ï¼Œä¸€èˆ¬å’ŒViewModelã€Roomã€LifeCycleåŒæ—¶ä»‹ç»ï¼Œå°¤å…¶æ˜¯LifeCycleå’ŒViewModelã€‚æœ€ç»ˆæ ¸å¿ƒè¿˜æ˜¯æœŸæœ›è¿™äº›ç»„ä»¶èƒ½ç”¨æœ‰æ•ˆçš„æ”¯æŒåœ¨Androidç«¯å®ç°MVVMã€‚</p>
</blockquote>

<h2 id="toc_1">MVP vs MVVM</h2>

<p>MVP æ˜¯MVCæ¨¡å¼çš„å˜ç§ï¼Œå®ƒå·²ç»å­˜åœ¨äº†æ•°åå¹´äº†ã€‚</p>

<pre><code class="language-text">Androidé¢†åŸŸå¹¿æ³›åº”ç”¨MVPæºäºGoogleåœ¨2016å¹´å¹´åˆæ¨å‡ºçš„Android Architecture Blueprints
</code></pre>

<p>MVPå’ŒMVCçš„æ ¸å¿ƒåŒºåˆ«åœ¨äºæ•°æ®æµä¼ è¾“å’Œç»„ç»‡æ–¹å¼ï¼Œå†…åœ¨æ€æƒ³æ˜¯é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä»£ä»·æ˜¯å¤§é‡èƒ¶æ°´ä»£ç ã€‚</p>

<p><img src="media/15613470463264/15613472117525.jpg" alt=""/></p>

<p>åœ¨2005å¹´ï¼Œå¾®è½¯çš„WPFå’ŒSLæ¶æ„å¸ˆJohn Gossmanåœ¨ä»–çš„åšå®¢ä¸­å…¬å¼€äº†MVVMæ¨¡å¼ã€‚æ˜¯ä¹‹å‰PMï¼ˆPresenter Modelï¼‰æ¨¡å¼çš„æ¼”åŒ–ã€‚</p>

<p>ä¸åƒMVPï¼ŒViewModel ä¸éœ€è¦Viewçš„å¼•ç”¨ã€‚Viewç»‘å®šåˆ°ViewModelä¸­çš„ä¸€ä¸ªå±æ€§ã€‚è¿™ä¸ªå±æ€§å±•ç¤ºäº†Modelå¯¹è±¡çš„æ•°æ®ä»¥åŠViewçš„å…¶å®ƒçŠ¶æ€ç‰¹æ€§ã€‚ç”±äºViewModel å¯¹è±¡è¢«è®¾ç½®ä¸ºViewçš„DataContentï¼ŒViewå’ŒViewModelä¹‹é—´çš„ç»‘å®šæ˜“äºæ„å»ºã€‚å¦‚æœViewModel é‡Œé¢çš„å±æ€§å€¼æ”¹å˜äº†ï¼Œé‚£äº›æ–°çš„å€¼ä¼šé€šè¿‡æ•°æ®ç»‘å®šä¼ é€’åˆ°Viewã€‚å½“ç”¨æˆ·ç‚¹å‡»Viewçš„ä¸€ä¸ªæŒ‰é’®ï¼ŒViewModel é‡Œé¢çš„ä¸€ä¸ªå‘½ä»¤å°±ä¼šæ‰§è¡Œå®Œæˆéœ€è¦çš„åŠ¨ä½œã€‚ViewModelè€Œä¸æ˜¯Viewæ‰§è¡Œäº†Modelæ•°æ®çš„ä¿®æ”¹ã€‚<code>Viewç±»ä¸çŸ¥é“Modelç±»çš„å­˜åœ¨ï¼ŒViewModel å’ŒModelä¹Ÿä¸çŸ¥é“View</code>ã€‚å®é™…ä¸Šï¼ŒModelå®Œå…¨ä¸çŸ¥é“ViewModelå’ŒViewå­˜åœ¨çš„äº‹å®ã€‚</p>

<blockquote>
<p>MVVMï¼šâ€œKeeping UI code simple and free of app logic in order to make it easier to manageâ€<br/>
ä¸€ç§ç»„ä»¶é€»è¾‘åˆ†ç¦»çš„æ¶æ„æ¨¡å¼ï¼Œè®©UIéƒ¨åˆ†é€»è¾‘æ›´åŠ å†…èšã€‚<br/>
æ³¨ï¼šä¸æ˜¯åå­—ä¸­æœ‰ViewModelã€VMçš„å°±æ˜¯MVVMæ¶æ„ï¼Œå°±åƒæœ‰çš„åå­—ä¸­å¸¦Presenterä¸ä¸€å®šå°±æ˜¯MVPï¼Œå®ƒå¾ˆå¯èƒ½åªæ˜¯æƒ³å†™ä¸€ä¸ªMVPæ¶æ„ã€‚</p>
</blockquote>

<p><img src="media/15613470463264/15613473603270.jpg" alt=""/></p>

<p><img src="media/15613470463264/15613473671528.jpg" alt=""/></p>

<p>MVVMçš„å…³é”®åœ¨äºåŒå‘ç»‘å®šï¼ŒLiveDataå°±æ˜¯ç”¨äºè§£å†³è¿™ä¸ªã€‚</p>

<blockquote>
<p>ViewModelç»„ä»¶æœ¬æ¬¡ä¸è¡¨ï¼Œå»ºè®®åç»­ç ”ç©¶ï¼Œæœ¬æ¬¡ä¸åšå‘æ•£ã€‚</p>
</blockquote>

<span id="more"></span><!-- more -->

<hr/>

<p><code>å®˜æ–¹æ¦‚å¿µç¯èŠ‚</code></p>

<h1 id="toc_2">ä¸€ã€ï¼ˆWhatï¼‰ä»€ä¹ˆæ˜¯LiveDataï¼Ÿ</h1>

<p><strong>ç®€å•è¯´å°±æ˜¯LifeCycleåœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­çš„ç»“åˆè¿ç”¨ã€‚</strong></p>

<p>LiveDataæœ‰å¾ˆå¤šå¥½å¤„ï¼ˆ<a href="https://tech.meituan.com/2018/07/26/android-livedatabus.html">ç¾å›¢æ›¾ç»ç”¨å®ƒæ›¿æ¢EventBus</a>)</p>

<ul>
<li><strong>UIå’Œå®æ—¶æ•°æ®ä¿æŒä¸€è‡´</strong> å› ä¸ºLiveDataé‡‡ç”¨çš„æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥åœ¨æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶è·å¾—é€šçŸ¥ï¼Œæ›´æ–°UIã€‚</li>
<li><strong>é¿å…å†…å­˜æ³„æ¼</strong> è§‚å¯Ÿè€…è¢«ç»‘å®šåˆ°ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸Šï¼Œå½“è¢«ç»‘å®šçš„ç»„ä»¶é”€æ¯ï¼ˆdestroyï¼‰æ—¶ï¼Œè§‚å¯Ÿè€…ä¼šç«‹åˆ»è‡ªåŠ¨æ¸…ç†è‡ªèº«çš„æ•°æ®ã€‚</li>
<li><p><strong>ä¸ä¼šå†äº§ç”Ÿç”±äºActivityå¤„äºstopçŠ¶æ€è€Œå¼•èµ·çš„å´©æºƒ</strong> å› ä¸ºæ ¹æœ¬æ”¶ä¸åˆ°é€šçŸ¥</p></li>
<li><p><strong>ä¸éœ€è¦å†è§£å†³ç”Ÿå‘½å‘¨æœŸå¸¦æ¥çš„é—®é¢˜</strong> LiveDataå¯ä»¥æ„ŸçŸ¥è¢«ç»‘å®šçš„ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œåªæœ‰åœ¨æ´»è·ƒçŠ¶æ€æ‰ä¼šé€šçŸ¥æ•°æ®å˜åŒ–ã€‚</p></li>
<li><p><strong>å®æ—¶æ•°æ®åˆ·æ–°</strong> å½“ç»„ä»¶å¤„äºæ´»è·ƒçŠ¶æ€æˆ–è€…ä»ä¸æ´»è·ƒçŠ¶æ€åˆ°æ´»è·ƒçŠ¶æ€æ—¶æ€»æ˜¯èƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚</p></li>
<li><p><strong>è§£å†³Configuration Changeé—®é¢˜</strong> åœ¨å±å¹•å‘ç”Ÿæ—‹è½¬æˆ–è€…è¢«å›æ”¶å†æ¬¡å¯åŠ¨ï¼Œç«‹åˆ»å°±èƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚-&gt;ä¾èµ–ViewModel</p></li>
</ul>

<blockquote>
<p>é‰´äºLiveDataçš„ç‰¹æ€§ï¼ˆç»“åˆMVVMä½¿ç”¨ï¼‰ï¼Œå¦‚æœè¿‡å»ä¹ æƒ¯ä½¿ç”¨RxJavaæ¥åšå“åº”å¼ç¼–ç¨‹ï¼Œé‚£ä¾ç„¶ç»§ç»­ç”¨ï¼Œå”¯ä¸€åŒºåˆ«å°±æ˜¯allocå’Œdeallocè®°å¾—æ³¨å†Œå’Œåæ³¨å†Œã€‚</p>
</blockquote>

<hr/>

<p><strong>æœ‰è¶£çš„ä½¿ç”¨ç¯èŠ‚</strong></p>

<h1 id="toc_3">äºŒã€ï¼ˆHowï¼‰LiveDataæ€ä¹ˆç”¨ï¼Ÿ</h1>

<blockquote>
<p>ä¸ªäººä¹ æƒ¯ï¼Œçœ‹æºç  å…ˆä½¿ç”¨-&gt;å·¥å…·ç±»-&gt;æœ€å¸¸ç”¨æ‰©å±•ç±»-&gt;æ ¸å¿ƒç±»</p>
</blockquote>

<h2 id="toc_4">æ™®é€šç”¨æ³•ï¼ˆActionDataManagerç”¨æ³•ï¼‰</h2>

<p>å¦‚ä½•åˆç†çš„ä½¿ç”¨ActionDataManager </p>

<ul>
<li>Tips1: LiveDataçš„Observeå…·æœ‰ç«‹å³å›è°ƒçš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¸éœ€è¦å•ç‹¬çš„é…ç½®åˆå§‹åŒ–</li>
<li>Tips2: LiveDataçš„setValueéœ€è¦ä¸»çº¿ç¨‹æ“ä½œï¼Œå¦åˆ™ç”¨postValueï¼Œä½†åœ¨åˆ‡çº¿ç¨‹çš„æ—¶å€™getValueå€¼ä¸æ­£ç¡®</li>
</ul>

<p>é»˜è®¤LiveDataæ˜¯abstract classï¼ŒsetValueå’ŒpostValueéƒ½æ˜¯protectedä¿®é¥°ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä½¿ç”¨<strong>MutableLiveData</strong>ï¼Œå”¯ä¸€åŒºåˆ«æ˜¯è¯¥ç±»çš„setValueå’ŒpostValueæ˜¯publicã€‚</p>

<pre><code class="language-java">LiveData&lt;ActionData&gt; liveData = ActionDataManager.INSTANCE.getActionLiveData(getId());
if (liveData != null) {
    liveData.observe(AbsUgcFeedFragment.this, new Observer&lt;ActionData&gt;() {
        @Override
        public void onChanged(@Nullable ActionData actionData) {
            // do some thing
        }
    });
}
</code></pre>

<p>ä¸Šè¿°ä»£ç ä¸­å°±å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨LiveDataï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰è§‚å¯Ÿåˆ°æ•°æ®å˜åŒ–åçš„æ“ä½œï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶æœºè§¦å‘æ•°æ®æ›´æ–°ã€‚</p>

<ul>
<li>observeåonChangedä¼šç«‹å³å›è°ƒ</li>
<li>LiveDataçš„æ›´æ–°åªä¼šåœ¨LifecycleOwnerçš„lifeCycleåœ¨Stateä¸ºRESUMEDå›è°ƒï¼Œå…¶ä»–æƒ…å†µä¸å›è°ƒ</li>
<li>é€šçŸ¥å˜åŒ–ä¼šåœ¨å›åˆ°å‰å°ï¼ˆRESUMEDï¼‰åä¸€èµ·å›è°ƒ</li>
<li>destroyedåä¼šè‡ªåŠ¨ç§»é™¤observer</li>
</ul>

<p>å¦‚æœä¸éœ€è¦ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¯ä»¥ä½¿ç”¨LiveData#observeForeverï¼Œä½†éœ€è¦æ‰‹åŠ¨removeObserverï¼š</p>

<pre><code class="language-java">liveData.observeForever(new Observer&lt;ActionData&gt;() {
    @Override
    public void onChanged(@Nullable ActionData actionData) {
        // do some thing
    }
});
</code></pre>

<h2 id="toc_5">è¿˜æœ‰ä¸€äº›æ¨èçš„é«˜çº§ç”¨æ³•</h2>

<blockquote>
<p>&quot;ä»¥ä¸‹ä¸‰ä¸ªç”¨æ³•å’Œä»£ç éƒ½æ¯”è¾ƒç²¾å¦™&quot;</p>
</blockquote>

<p><strong>1ã€Transformations#map()</strong><br/>
ç”¨äºæ˜¯æŠŠä¸€ä¸ªæ•°æ®ç±»å‹å˜æ¢ä¸ºå¦å¤–ä¸€ä¸ªæ•°æ®ç±»å‹ã€‚</p>

<pre><code class="language-kotlin">val userLiveData: LiveData = UserLiveData() // valueæ˜¯Userï¼Œæœ‰nameå’Œlastnameä¸¤å±æ€§
val userName: LiveData = Transformations.map(userLiveData) {    
    user -&gt; &quot;${user.name} ${user.lastName}&quot;
} // valueæ˜¯String
</code></pre>

<p>æºç å®ç°ï¼š<br/>
<img src="media/15613470463264/15613480338221.jpg" alt=""/></p>

<p>è¿™é‡Œç”¨åˆ°äº† LiveData çš„å¦ä¸€ä¸ªå­ç±» MediatorLiveDataã€‚æ¥ä¸‹æ¥çœ‹ä¸€çœ‹è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚</p>

<p><strong>MediatorLiveData</strong><br/>
ä» <code>Transformations#map()</code> æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒMediatorLiveData æœ‰ä¸€ä¸ª <code>MediatorLiveData#addSource()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ”¹å˜äº†æ•°æ®å†…å®¹ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>MediatorLiveData</code> å°†å¤šä¸ª LiveData æºæ•°æ®é›†åˆèµ·æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <br/>
<img src="media/15613470463264/15613480748320.jpg" alt=""/></p>

<p>ä¸€æ®µDemo</p>

<pre><code class="language-kotlin">class MediatorLiveDataFragment : Fragment() {     
    private val changeObserver = Observer&lt;String&gt; { 
        value -&gt;  value?.let { txt_fragment.text = it }    
    }     

    override fun onAttach(context: Context?) {        
        super.onAttach(context)        
        val mediatorLiveData = MediatorLiveData&lt;String&gt;()        
        mediatorLiveData.addSource(getliveDataA())  { 
            mediatorLiveData.value = &quot;A:$it&quot; 
        }        
        mediatorLiveData.addSource(getliveDataB())   { 
            mediatorLiveData.value = &quot;B:$it&quot; 
        }        
        mediatorLiveData.observe(this, changeObserver)    
    }    
    // .. some other Fragment specific code .. 
}
</code></pre>

<p><strong>ç‰¹å¾ï¼š</strong></p>

<ul>
<li>ä»»ä½•ä¸€ä¸ªLiveDataçš„æ›´æ–°éƒ½ä¼šå›è°ƒè¯¥sourceçš„Observerï¼ˆç”¨äº†observeForeverï¼Œä½†ç”Ÿå‘½å‘¨æœŸæ—¶æœºå’ŒçœŸå®çš„LifeCycleOwnerä¸€è‡´ï¼‰</li>
<li>ä¸å¯è§çŠ¶æ€åŒæ—¶ä¿®æ”¹LiveDataæºï¼Œåaddçš„sourceåè°ƒç”¨<br/>
ç”¨é€”ï¼šåŒæ—¶ç›‘å¬ç½‘ç»œå›æ¥æ•°æ®çš„LiveDataå’Œæ•°æ®åº“æ•°æ®LiveData</li>
</ul>

<p><strong>Transformations#switchMap()</strong><br/>
æŠŠä¸€ä¸ªæ•°æ®å˜åŒ–ä¸ºå¦å¤–ä¸€ä¸ª LiveData ã€‚<br/>
<strong>ç‰¹å¾ï¼š</strong>æ ¹æ®SwitchLiveDataï¼ˆç”¨äºæ§åˆ¶çš„LiveDataï¼‰åŠ¨æ€åˆ‡æ¢LiveDataã€‚<br/>
<strong>ç”¨é€”ï¼š</strong>ç™»å½•é€»è¾‘ï¼ˆé€‰ä¸ªå¼€å…³ï¼Œæ¢æˆå¯†ç ç™»å½•ã€éªŒè¯ç ç™»å½•ç­‰ç­‰ï¼‰</p>

<p>æºç å®ç°ï¼š<br/>
<img src="media/15613470463264/15613481127829.jpg" alt=""/></p>

<hr/>

<p><strong>æ¯ç‡¥æ— å‘³çš„ä»£ç ç¯èŠ‚</strong></p>

<h1 id="toc_6">ä¸‰ã€ï¼ˆWhyï¼‰LiveDataæ€ä¹ˆå®ç°çš„ï¼Ÿ</h1>

<blockquote>
<p>æ­¤å¤„éœ€è¦ä¸€äº›å‰ç½®æ¦‚å¿µï¼ŒLifecycleã€LifecycleOwnerã€Lifecyclingã€FullLifecycleObserverã€GenericLifecycleObserverã€LifecycleObserver<br/>
Lifecyclingæ•´ä¸ªæ¡†æ¶è®¾è®¡æ¯”è¾ƒæœ‰è¶£ï¼Œå»ºè®®ç ”ç©¶ä¸‹ï¼Œé¿å…å‘æ•£ï¼Œæœ¬æ¬¡ä¸è¡¨ã€‚</p>
</blockquote>

<h2 id="toc_7">æ¨¡ç‰ˆæ–¹æ³•</h2>

<ul>
<li><code>onActive()</code>ï¼šæ–¹æ³•åœ¨LiveDataè‡³å°‘æœ‰ä¸€ä¸ªæ´»è·ƒçš„observerï¼ˆRESUMEï¼‰çš„æ—¶å€™æ‰ä¼šè°ƒç”¨</li>
<li><code>onInactive()</code>ï¼šå½“LiveDataæ²¡æœ‰ä¸€ä¸ªæ´»è·ƒçš„è§‚å¯Ÿè€…çš„æ—¶å€™è¿™ä¸ªæ–¹æ³•ä¼šè¢«è°ƒç”¨
ä¸Šè¿°æ–¹æ³•ä¼šåœ¨ä»»ä½•ä¸€ä¸ªLifecycleOwnerçš„stateæ”¹å˜æ—¶å°è¯•checkä¸€æ¬¡ã€‚<br/>
MediatorLiveDataå°±ä½¿ç”¨äº†ä¸Šè¿°æ—¶æœºã€‚</li>
</ul>

<h2 id="toc_8">é‡è¦Publicæ–¹æ³•</h2>

<ul>
<li><code>setValue()</code>ï¼šå³æ—¶æ›´æ–°ï¼Œéœ€è¦åœ¨ä¸»çº¿ç¨‹</li>
<li><code>postValue()</code>ï¼šä¸‹ä¸€ä¸ªmain message loopæ›´æ–°ã€‚ä¸åŠæ—¶</li>
<li><code>observe()</code>ï¼šæœ›æ–‡ç”Ÿä¹‰ï¼Œobserveä¼šç«‹å³æ”¶åˆ°changeå›è°ƒ</li>
<li><code>observeForever()</code> ï¼šæœ›æ–‡ç”Ÿä¹‰</li>
<li><code>removeObserver()</code> ï¼šæœ›æ–‡ç”Ÿä¹‰ï¼Œremoveæ“ä½œä¸ä¼šé€ æˆchangeå›è°ƒ</li>
<li><code>removeObservers()</code> ï¼šæœ›æ–‡ç”Ÿä¹‰</li>
</ul>

<h2 id="toc_9">ç±»å›¾ï¼š</h2>

<p><img src="media/15613470463264/15613481777805.jpg" alt=""/></p>

<h2 id="toc_10">è°ƒç”¨æ—¶åºå›¾ï¼š</h2>

<p><img src="media/15613470463264/15613481877141.jpg" alt=""/></p>

<p>ä¸‹é¢ç»“åˆLiveDataçš„ä¸¤ä¸ªæ­¥éª¤åˆ†æï¼Œä¸ºä»€ä¹ˆLiveDataå…·æœ‰Googleç»™å‡ºçš„è¿™ä¹ˆå¤šç‰¹ç‚¹ã€‚æŒ‰ç…§ä½¿ç”¨æ¥è¯´ï¼ŒLiveDataä¸»è¦æ˜¯åˆ†ä¸ºè®¢é˜…å’Œé€šçŸ¥ä¸¤ä¸ªæ­¥éª¤ã€‚</p>

<h2 id="toc_11">è®¢é˜…</h2>

<pre><code class="language-java">@MainThread
public void observe(@NonNull LifecycleOwner owner, @NonNull Observer observer) {
    if (owner.getLifecycle().getCurrentState() == DESTROYED) {
        // ignore
        return;
    }
    LifecycleBoundObserver wrapper = new LifecycleBoundObserver(owner, observer);
    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);
    if (existing != null &amp;&amp; !existing.isAttachedTo(owner)) {
        throw new IllegalArgumentException(&quot;Cannot add the same observer&quot;
            + &quot; with different lifecycles&quot;);
    }
    if (existing != null) {
        return;
    }
    owner.getLifecycle().addObserver(wrapper);
}

class LifecycleBoundObserver extends ObserverWrapper implements GenericLifecycleObserver {
    @NonNull final LifecycleOwner mOwner;
     ...
    @Override
    boolean shouldBeActive() {
        return mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);
    }
    @Override
    public void onStateChanged(LifecycleOwner source, Lifecycle.Event event) {
        if (mOwner.getLifecycle().getCurrentState() == DESTROYED) {
            removeObserver(mObserver);
            return;
        }
        activeStateChanged(shouldBeActive());
    }
    ...
    @Override
    void detachObserver() {
        mOwner.getLifecycle().removeObserver(this);
    }
}
</code></pre>

<p>è®¢é˜…åŠ¨ä½œåšäº†ä¸¤ä»¶äº‹</p>

<ol>
<li>å°†è§‚å¯Ÿè€…å¯¹è±¡ä¸LifecycleOwnerç»‘å®šæˆä¸€ä¸ªLifecycleBoundObserverï¼Œå¹¶å½¢æˆè§‚å¯Ÿè€…ä¸LifecycleBoundObserverçš„æ˜ å°„ï¼›</li>
<li>LifecycleBoundObserverè§‚å¯ŸLifecycleOwnerçš„ç”Ÿå‘½å‘¨æœŸã€‚<br/>
è¿™å°±å®ç°äº†Observeræ˜¯æ•°æ®è§‚å¯Ÿè€…ï¼ŒLifecycleBoundObserveræ˜¯ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…ï¼Œè§‚å¯ŸLifecycleOwnerçš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ol>

<h2 id="toc_12">é€šçŸ¥</h2>

<p>é€šçŸ¥æœ‰ä¸¤ç§å½¢å¼ï¼Œåˆ†åˆ«æ˜¯æ•°æ®å˜åŒ–é€šçŸ¥å’ŒLifecycleOwnerç”Ÿå‘½å‘¨æœŸå˜åŒ–é€šçŸ¥ã€‚</p>

<h2 id="toc_13">æ•°æ®å˜åŒ–é€šçŸ¥ï¼š</h2>

<p>setValueæ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„æ•°æ®æ›´æ–°æ–¹æ³•ï¼ŒpostValueæ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œçš„æ•°æ®æ›´æ–°æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æœ€åéƒ½è°ƒç”¨åˆ°äº†dispatchingValue(null)ã€‚</p>

<pre><code class="language-java">private void dispatchingValue(@Nullable ObserverWrapper initiator) {
    if (mDispatchingValue) {
        mDispatchInvalidated = true;
        return;
    }
    mDispatchingValue = true;
    do {
        mDispatchInvalidated = false;
        if (initiator != null) {
            considerNotify(initiator);
            initiator = null;
        } else {
            for (Iterator&lt;Map.Entry&lt;Observer&lt;T&gt;, ObserverWrapper&gt;&gt; iterator =
                mObservers.iteratorWithAdditions(); iterator.hasNext(); ) {
                considerNotify(iterator.next().getValue());
                if (mDispatchInvalidated) {
                    break;
                }
            }
        }
    } while (mDispatchInvalidated);
    mDispatchingValue = false;
}

private void considerNotify(ObserverWrapper observer) {
    if (!observer.mActive) {
        return;
    }
    if (!observer.shouldBeActive()) {
        observer.activeStateChanged(false);
        return;
    }
    if (observer.mLastVersion &gt;= mVersion) {
        return;
    }
    observer.mLastVersion = mVersion;
    //noinspection unchecked
    observer.mObserver.onChanged((T) mData);
}
</code></pre>

<p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹<br/>
<img src="media/15613470463264/15613482356986.jpg" alt=""/></p>

<h2 id="toc_14">LifecycleOwnerçš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–é€šçŸ¥ï¼š</h2>

<pre><code class="language-java">class LifecycleBoundObserver extends ObserverWrapper implements GenericLifecycleObserver {
    @Override
    public void onStateChanged(LifecycleOwner source, Lifecycle.Event event) {
        if (mOwner.getLifecycle().getCurrentState() == DESTROYED) {
            removeObserver(mObserver);
            return;
        }
        activeStateChanged(shouldBeActive());
    }
}

private abstract class ObserverWrapper {
    void activeStateChanged(boolean newActive) {
        if (newActive == mActive) {
            return;
        }
        // immediately set active state, so we&#39;d never dispatch anything to inactive
        // owner
        mActive = newActive;
        boolean wasInactive = LiveData.this.mActiveCount == 0;
        LiveData.this.mActiveCount += mActive ? 1 : -1;
        if (wasInactive &amp;&amp; mActive) {
            onActive();
        }
        if (LiveData.this.mActiveCount == 0 &amp;&amp; !mActive) {
            onInactive();
        }
        if (mActive) {
            dispatchingValue(this);
        }
    }
}
</code></pre>

<p>LifecycleBoundObserveræ³¨å†Œäº†LifecycleOwnerçš„ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œå½“å®ç°äº†LifecycleOwnerçš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–æ—¶ï¼ŒLifecycleå›è°ƒonStateChangedï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ã€‚<br/>
<img src="media/15613470463264/15613482737458.jpg" alt=""/></p>

<p>å½“è§‚å¯Ÿè€…æ•°é‡ä»0åˆ°1æ—¶è°ƒç”¨onActiveï¼Œä»1åˆ°0è°ƒç”¨onInactiveï¼Œæœ€åèµ°æ•°æ®æ´¾å‘ã€‚ä¸¾ä¾‹ï¼Œè§‚å¯Ÿè€…ç»„ä»¶ä»åå°åˆ‡åˆ°å‰å°æ—¶ï¼ŒmActiveçŠ¶æ€ä»falseå˜ä¸ºtrueï¼ŒLiveDataæ‰§è¡Œäº†dispatchValueï¼Œæ‰€ä»¥è§‚å¯Ÿè€…å¯¹è±¡èƒ½æ”¶åˆ°LiveDataæœ€åæ›´æ–°çš„æ•°æ®ã€‚</p>

<h2 id="toc_15">æ€»ç»“</h2>

<p>LiveDataä½œä¸ºæ•°æ®è§‚å¯Ÿè€…ï¼Œä¸ä»…èƒ½è§‚å¯Ÿæ•°æ®å˜åŒ–ï¼Œè¿˜èƒ½æ„ŸçŸ¥ç»„ä»¶ç”Ÿå‘½å‘¨æœŸï¼Œè¿™å°±å†³å®šäº†ä¸ºä»€ä¹ˆèƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚åœ¨ç»„ä»¶ä¸å†activeä¹‹åï¼Œä¸ä¼šå†æ”¶åˆ°æ•°æ®å›è°ƒã€‚è¿˜æœ‰ç»„ä»¶ä»inactiveåˆ°activeçŠ¶æ€æ—¶ï¼Œåˆèƒ½æ¥å—åˆ°æœ€æ–°çš„æ•°æ®ã€‚</p>

<p>å…³äºGoogleè‡ªç§°è§£å†³Configuration Changeé—®é¢˜ï¼Œåœ¨å±å¹•å‘ç”Ÿæ—‹è½¬æˆ–è€…è¢«å›æ”¶å†æ¬¡å¯åŠ¨ï¼Œç«‹åˆ»å°±èƒ½æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚<br/>
è¿™ä¸ªè¯´æ³•æ²¡é”™ï¼ŒçŠ¶æ€å˜æ›´æ˜¯èƒ½æ”¶åˆ°æœ€æ–°æ•°æ®ï¼Œä½†æ˜¯è¿™è¦æ±‚LiveData æ²¡æœ‰è¢«é”€æ¯ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬å¦å¤–å­˜å‚¨ä¿å­˜LiveData ï¼Œåœ¨LiveDataç±»çš„æ³¨é‡Šä¸­ï¼Œæœ€åä¸€æ®µè¿™æ ·å†™åˆ°ï¼š<br/>
<img src="media/15613470463264/15613482851187.jpg" alt=""/></p>

<hr/>

<ul>
<li>æ¨èå…¶ä»–é˜…è¯»ï¼šLiveData beyond the ViewModelâ€Šâ€”â€ŠReactive patterns using Transformations and MediatorLiveData </li>
</ul>

			</div>

		
	  
		<footer>
		 <p class="meta">

			<strong>Categories:</strong>&nbsp; 
			<span class="categories">
			
			    <a class='category' href='tech.html'>æŠ€æœ¯</a>&nbsp;
			 
			</span>
		    </p>
		    <p class="meta">
		      
		 </p>
	    
		<div class="sharing">
		  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'billchaiblog';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
          
            <div id="disqus_thread"></div>
          

          

		</div>

	    <p class="meta">
	    
	    
	        <a class="basic-alignment right" href="15498584515544.html" 
	        title="Next Post: å†™åœ¨19å¹´æ–°å¹´ä¸Šç­ç¬¬ä¸€å¤©">å†™åœ¨19å¹´æ–°å¹´ä¸Šç­ç¬¬ä¸€å¤© &raquo;</a>
	    
	    </p>
	  </footer>
	</article>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="tech.html"><strong>æŠ€æœ¯&nbsp;(59)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Anything.html"><strong>èƒ¡å†™&nbsp;(16)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="QDaily.html"><strong>QDaily&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15613470463264.html">LiveDataç»„ä»¶åˆ†äº«</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15498584515544.html">å†™åœ¨19å¹´æ–°å¹´ä¸Šç­ç¬¬ä¸€å¤©</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15446191606030.html">å›¢é˜Ÿç®¡ç†çš„æ„Ÿæ…¨ï¼šä¸è¦è®©æœ‰å…±åŒç‰¹å¾çš„äººèµ°çš„å¤ªè¿‘</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15438122075796.html">å¤´æ¡æµ‹è¯•å†…é“¾</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15407404509104.html">Retro Meeting -> å›¢é˜Ÿçš„è‡ªæˆ‘ç–—ä¼¤</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>


<script type="text/javascript">
    var disqus_shortname = 'billchaiblog'; 

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
var disqus_shortname = 'billchaiblog'; 

(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
  
    




</body>
</html>