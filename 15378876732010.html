
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  AFNæºç åˆ†æ-AFHTTPConnectionOperation - é‡ç«ğŸ”¥
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="ç”Ÿå‘½å¦‚é‡ç«ï¼Œéª„å‚²è€Œé¡½å¼º">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="é‡ç«ğŸ”¥" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//é“¾æ¥æ–°å¼€çª—å£
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">é‡ç«ğŸ”¥</a></h1>
  
    <h2>ç”Ÿå‘½å¦‚é‡ç«ï¼Œéª„å‚²è€Œé¡½å¼º</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.chaisong.xyz" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">Home</a></li>

  <li id=""><a target="_self" href="archives.html">Archives</a></li>

  <li id=""><a target="_self" href="aboutme.html">ABOUT ME</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div>
	<article class="hentry" role="article">
	<header>
			  	<h1 class="entry-title">AFNæºç åˆ†æ-AFHTTPConnectionOperation</h1>
				<p class="meta"><time datetime="2016-03-13T23:01:13+08:00" pubdate data-updated="true">2016/3/13</time></p>
			 </header>
		  	<div class="entry-content">
			  	<blockquote>
<p>AFHTTPConnectionOperationæ˜¯AFNetWorkingåœ¨ä½¿ç”¨NSURLConnectionè¿›è¡Œç½‘ç»œè¯·æ±‚å’Œä¸‹è½½çš„åŸºæœ¬ä»»åŠ¡å•å…ƒï¼Œå…¶ç»§æ‰¿è‡ªAFURLConnectionOperationï¼Œä»…å¯¹å…¶è¿›è¡Œäº†ä¸€äº›ä¸å¤ªå¤æ‚çš„å°è£…ã€‚åœ¨æ•´ä¸ªæ¡†æ¶ä¸­ï¼ŒAFNå¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨è¿‡AFURLConnectionOperationï¼Œå‡ä¸ºé¢å‘AFHTTPConnectionOperationçš„ä¸€äº›å¼€å‘å·¥ä½œï¼Œä½†ä½œä¸ºæŠ½è±¡æ›´å¥½çš„Operationï¼Œéœ€è¦è¿›è¡Œä¼˜å…ˆçš„åˆ†æä¸å­¦ä¹ ã€‚<br/>
<!--more--></p>

<h3 id="toc_0">AFURLConnectionOperation</h3>

<p>æœ¬ç±»æ˜¯NSOperationçš„å­ç±»ï¼Œå¤©ç„¶å°±æ˜¯åšå…·ä½“ä»»åŠ¡æ“ä½œçš„ã€‚ç”±äºè¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œæ‰€ä»¥implementäº†NSURLConnectionDelegateå’ŒNSURLConnectionDataDelegateä¸¤ä¸ªæœˆç½‘ç»œç›¸å…³çš„ä»£ç†ã€‚</p>
</blockquote>

<p>ç”±äºè¿‡å¤šçº¿ç¨‹æœ¬èº«ä¼šæ¯”è¾ƒåƒèµ„æºï¼ŒåŒæ—¶è¿˜ä¼šæœ‰åŒæ­¥é—®é¢˜ï¼ŒAFNå°†æ‰€æœ‰ç½‘ç»œè¯·æ±‚çš„è°ƒç”¨éƒ½ç»Ÿä¸€æ”¾åœ¨äº†ä¸€ä¸ªåä¸ºâ€œAFNetWorkingâ€çš„threadï¼ˆä»¥ä¸‹ç®€ç§°AFThreadï¼‰ä¸­ã€‚è¯¥threadçš„åˆ›å»ºæ”¾åœ¨äº†å…·ä½“çš„Operationä¸­ï¼Œä½¿ç”¨æ‡’åŠ è½½ï¼Œå¹¶ç”¨dispatch_once_tè¿›è¡Œå¤šçº¿ç¨‹å•ä¾‹åˆ›å»ºã€‚</p>

<p>ç±»ä¸­æŒæœ‰ä¸€ä¸ªNSRecursiveLockçš„lockï¼Œè¿›è¡Œå¤šçº¿ç¨‹çš„åŒæ­¥æ“ä½œï¼Œæ‰€æœ‰è¯»å†™è°ƒç”¨æ“ä½œéƒ½ä¼šlockåŠ é”ã€‚</p>

<p>Operationå¯åŠ¨åï¼Œä¼šåœ¨AFThreadè°ƒèµ·operationDidStartæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ–°å»ºNSURLConnectionå¹¶åŠ å…¥å½“å‰çº¿ç¨‹runloopä¸­ï¼Œç„¶åå¯åŠ¨ç½‘ç»œè¯·æ±‚ã€‚æ•´ä¸ªè¿‡ç¨‹ä¼šåˆ¤æ–­isCancelï¼Œcancelå°±ä¼šåœæ­¢è¯¥operationã€‚</p>

<p>Operationè°ƒç”¨cancelæ–¹æ³•åï¼Œä¼šåœ¨AFThreadçº¿ç¨‹è°ƒèµ·cancelConnectionæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°†å½“å‰å·²æœ‰çš„connectionæ–­æ‰å¹¶å—²ç”¨ä»£ç†æ–¹æ³•connection:didFailWithError:ï¼Œå°†å°è£…çš„cancel errorå‘é€å‡ºå»ã€‚cancelçš„è°ƒç”¨åŠ é”ï¼Œä¸¥æ ¼çº¿ç¨‹åŒæ­¥ã€‚</p>

<p>pauseæ–¹æ³•åŒæ ·æ˜¯åœ¨åŠ é”æƒ…å†µä¸‹ä½¿ç”¨ï¼Œé¿å…çŠ¶æ€ä¸åŒæ­¥é—®é¢˜ã€‚ä¼šåœ¨AFTheadçº¿ç¨‹è°ƒç”¨operationDidPauseæ–¹æ³•ï¼Œæ–¹æ³•ä¼šå°†å·²æœ‰connection cancelæ‰ã€‚</p>

<p>resumeæ˜¯é‡æ–°è°ƒèµ·startæ–¹æ³•ï¼Œè°ƒç”¨å‰éœ€åˆ¤æ–­æ˜¯ä¸æ˜¯åœ¨pauseçŠ¶æ€ä¸‹ï¼Œç„¶åå°†ç›¸å…³çš„çŠ¶æ€åˆå§‹åŒ–ã€‚ä½¿ç”¨ä¹Ÿç”¨åŠ é”æ–¹å¼ä¸¥æ ¼çº¿ç¨‹åŒæ­¥ã€‚</p>

<p>æ•°æ®ä¸Šä¼ å’Œä¸‹è½½è¿‡ç¨‹ä¸­ï¼Œæ›´æ–°è¿›åº¦çš„downloadProgresså’ŒuploadProgresséƒ½ä¼šä¸¥æ ¼åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œè¿™ä¸ªä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Ÿä¸€èˆ¬åº”è¯¥åœ¨completeQueueä½¿ç”¨å§ã€‚</p>

<p>NSURLConnetionçš„ä»£ç†å›è°ƒçº¿ç¨‹ä¸€å®šåœ¨å’Œè°ƒç”¨çº¿ç¨‹ä¸€è‡´ï¼Œæ‰€ä»¥åªè¦åœ¨ä¸»åŠ¨è°ƒèµ·ä»£ç†æ–¹æ³•æ—¶å€™æ³¨æ„å½“å‰çº¿ç¨‹é—®é¢˜å³å¯ï¼Œä¸éœ€è¦åœ¨ä»£ç†æ–¹æ³•é‡Œè¿›è¡ŒåŠ é”æ“ä½œã€‚</p>

<p>ä¸€ä¸ªå°æŠ€å·§è¦æ³¨æ„ï¼šæœ¬Operationä¸­çš„å¾ˆå¤šçŠ¶æ€éƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„stateè¿›è¡Œè¯†åˆ«å’Œæ ‡å¿—ï¼Œç”¨ä»¥æ›¿ä»£è¦†å†™NSOperationä¸­å¾—ä¸€äº›é»˜ç„¶æ–¹æ³•ï¼Œä¸ºæ”¯æŒKVOï¼Œéœ€è¦å°†stateæ”¹å˜çš„æ—¶å€™æ‰‹åŠ¨è°ƒèµ·ä¸çŠ¶æ€æ”¹å˜æœ‰å…³çš„çˆ¶ç±»å¯¹åº”å˜é‡çš„willChangeValueForKeyå’ŒdidChangeValueForKeyæ–¹æ³•ã€‚</p>

<p>completeQueueåœ¨ä¼ å…¥ä¸ºnilæ—¶é»˜è®¤ä½¿ç”¨ä¸»çº¿ç¨‹é˜Ÿåˆ—ã€‚</p>

<p>åœ¨Operation completeæ—¶ï¼Œæœ‰ä¸€å¤„éœ€è¦å­¦äº›çš„GCD groupçš„ä½¿ç”¨ï¼š</p>

<pre><code class="language-objectivec">dispatch_group_t group = strongSelf.completionGroup ?: url_request_operation_completion_group();
dispatch_queue_t queue = strongSelf.completionQueue ?: dispatch_get_main_queue();
dispatch_group_async(group, queue, ^{
    block();
});
dispatch_group_notify(group, url_request_operation_completion_queue(), ^{
    [strongSelf setCompletionBlock:nil];
});
</code></pre>

<p>æœ¬operationè¿˜æä¾›äº†ä¸€ä¸ªèƒ½å¤Ÿå¤šurlè¯·æ±‚ä¾èµ–å®Œæˆç»Ÿä¸€å›è°ƒçš„æ–¹æ³•å°è£…batchOfRequestOperations:progressBlock:completionBlock:ï¼Œé€šè¿‡å°è£…å¯ä»¥åœ¨è°ƒç”¨æ–¹è§‚å¯Ÿè‹¥å¹²ä¸ªç½‘ç»œè¯·æ±‚operationè¿›åº¦å’Œå®Œæˆæƒ…å†µã€‚æ–¹æ³•åˆ†åˆ«ä¼ å…¥éœ€è¦è§‚å¯Ÿçš„ç½‘ç»œè¯·æ±‚operationã€è¿›åº¦è§‚å¯Ÿçš„blockå’Œå®Œæˆè§‚å¯Ÿçš„blockï¼Œè¿”å›å€¼ä¸ºä¸€ä¸ªoperationçš„Arrayï¼ˆæœ¬è´¨å°±æ˜¯ä¸ºæ‰€æœ‰operationåŠ äº†ä¸€ä¸ªç›¸åŒçš„groupQueueï¼Œå¹¶æ–°å»ºä¸€ä¸ªOperationï¼Œå°†æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚Operationéƒ½åŠ å…¥å…¶ä¾èµ–ï¼‰ã€‚ä»£ç ä¸­æœ‰ä¸€äº›è®¾è®¡GCD groupå’Œoperationçš„dependencyç›¸å…³çš„ä½¿ç”¨æ–¹æ³•å€¼å¾—å­¦ä¹ ï¼š</p>

<pre><code class="language-objectivec">__block dispatch_group_t group = dispatch_group_create();
NSBlockOperation *batchedOperation = [NSBlockOperation blockOperationWithBlock:^{
    dispatch_group_notify(group, dispatch_get_main_queue(), ^{
        if (completionBlock) {
            completionBlock(operations);
        }
    });
}];

for (AFURLConnectionOperation *operation in operations) {
    operation.completionGroup = group;
    void (^originalCompletionBlock)(void) = [operation.completionBlock copy];
    __weak __typeof(operation)weakOperation = operation;
    operation.completionBlock = ^{
        __strong __typeof(weakOperation)strongOperation = weakOperation;
        dispatch_queue_t queue = strongOperation.completionQueue ?: dispatch_get_main_queue();
        dispatch_group_async(group, queue, ^{
            if (originalCompletionBlock) {
                originalCompletionBlock();
            }
            NSUInteger numberOfFinishedOperations = [[operations indexesOfObjectsPassingTest:^BOOL(id op, NSUInteger __unused idx,  BOOL __unused *stop) {
                return [op isFinished];
            }] count];
            if (progressBlock) {
                progressBlock(numberOfFinishedOperations, [operations count]);
           }
            dispatch_group_leave(group);
        });
    };
    dispatch_group_enter(group);
    [batchedOperation addDependency:operation];
}
</code></pre>

<p>ä¸Šé¢ä»£ç æŠ€å·§åŒ…æ‹¬</p>

<ul>
<li>å¼‚æ­¥blockä½¿ç”¨groupéœ€è¦åœ¨å¯¹åº”ä½ç½®ä½¿ç”¨dispatch_group_enterå’Œdispatch_group_leaveæ–¹æ³•ï¼Œå¦åˆ™blockä¸ä¼šæ‰§è¡Œï¼Œè¿™é‡Œçš„groupæ“ä½œåªä¼šå°†blockå—æ”¾åˆ°é˜Ÿåˆ—é‡Œè€Œå·²ã€‚</li>
<li><strong>weakæ ‡è®°äº†å¯¹è±¡é¿å…blocké€ æˆå¾ªç¯å¼•ç”¨ï¼›</strong>strongæ ‡è®°å·²ç»è¢«weakæ ‡è®°äº†å¾—å¯¹è±¡ï¼Œä½¿å¾—å¯¹è±¡åœ¨blockä½¿ç”¨è¿‡ç¨‹ä¸­ä¸ä¼šè¢«é‡Šæ”¾ã€‚</li>
<li>addDependency:æ–¹æ³•å¯ä»¥ä½¿åœ¨ä¸€ä¸ªqueueä¸Šçš„è‹¥å¹²ä¸ªoperationå¢åŠ ç›¸äº’é—´çš„ä¾èµ–å…³ç³»ï¼Œä½¿å…¶å¯ä»¥æœ‰ä¸€å®šé¡ºåºå…ˆåæ‰§è¡Œ</li>
<li>å¦‚æœblockä¸­æƒ³ä¿®æ”¹å¤–éƒ¨å˜é‡æŒ‡é’ˆçš„æŒ‡å‘ï¼Œéœ€è¦å¯¹å˜é‡å¢åŠ __blockä¿®é¥°å…³é”®å­—ï¼Œå¦åˆ™blockåªæ˜¯copyäº†ä¸€ä»½æŒ‡é’ˆè¿‡æ¥ï¼Œblockèƒ½ä¿®æ”¹çš„ï¼Œåªæ˜¯æŒ‡é’ˆæŒ‡å‘çš„å †å†…å­˜ä¸­å¾—æ•°æ®</li>
</ul>

<p>æœ¬ç±»å¯ä»¥æ¯”è¾ƒå¤šå¾—æ”¶è·åˆ°å…³äºçº¿ç¨‹åŒæ­¥ä»¥åŠå¤šçº¿ç¨‹ä¸€äº›æ“ä½œçš„çŸ¥è¯†è¿ç”¨ã€‚</p>

<h3 id="toc_1">AFHTTPRequestOperation</h3>

<p>ä½œä¸ºå­ç±»ï¼ŒåŸºæœ¬çš„åŠŸèƒ½å°±æ˜¯å¯¹åŸºç±»çš„ä¸€äº›å°è£…å’Œæ‰©å±•</p>

			</div>

		
	  
		<footer>
		 <p class="meta">

			<strong>Categories:</strong>&nbsp; 
			<span class="categories">
			
			    <a class='category' href='tech.html'>æŠ€æœ¯</a>&nbsp;
			 
			</span>
		    </p>
		    <p class="meta">
		      
		 </p>
	    
		<div class="sharing">
		  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'billchaiblog';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
          
            <div id="disqus_thread"></div>
          

          

		</div>

	    <p class="meta">
	    
	        <a class="basic-alignment left" href="15378876730358.html" 
	        title="Previous Post: è‡ªå®šä¹‰Androidå¼€æºåº“CSKitä»‹ç»">&laquo; è‡ªå®šä¹‰Androidå¼€æºåº“CSKitä»‹ç»</a>
	    
	    
	        <a class="basic-alignment right" href="15378876731943.html" 
	        title="Next Post: AFNæºç åˆ†æ-AFURLRequestSerialization">AFNæºç åˆ†æ-AFURLRequestSerialization &raquo;</a>
	    
	    </p>
	  </footer>
	</article>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="tech.html"><strong>æŠ€æœ¯&nbsp;(59)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Anything.html"><strong>èƒ¡å†™&nbsp;(16)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="QDaily.html"><strong>QDaily&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15613470463264.html">LiveDataç»„ä»¶åˆ†äº«</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15498584515544.html">å†™åœ¨19å¹´æ–°å¹´ä¸Šç­ç¬¬ä¸€å¤©</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15446191606030.html">å›¢é˜Ÿç®¡ç†çš„æ„Ÿæ…¨ï¼šä¸è¦è®©æœ‰å…±åŒç‰¹å¾çš„äººèµ°çš„å¤ªè¿‘</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15438122075796.html">å¤´æ¡æµ‹è¯•å†…é“¾</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15407404509104.html">Retro Meeting -> å›¢é˜Ÿçš„è‡ªæˆ‘ç–—ä¼¤</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>


<script type="text/javascript">
    var disqus_shortname = 'billchaiblog'; 

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
var disqus_shortname = 'billchaiblog'; 

(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
  
    




</body>
</html>